<!DOCTYPE html>
<html lang="it">

<head th:replace="~{fragments/header :: header(title='SiwFood - Modifica Ricetta')}">
	<style>
		.image-container img {
			width: 100%;
			object-fit: cover;
			max-height: 280px;
			min-height: 280px;
		}

		.scrollable-container {
			max-height: 300px;
			overflow-y: auto;
		}
	</style>
</head>

<body>
	<!-- Include la navbar -->
	<div th:replace="~{fragments/navbar :: navbar}"></div>

	<div class="container form-container mt-5">
		<h2 class="text-center mb-4">Modifica Ricetta</h2>
		<form th:action="@{/update/ricetta/{id}(id=${ricetta.id})}" method="post" enctype="multipart/form-data">
			<div class="row">
				<!-- Colonna Immagini attuali -->
				<div class="col-md-4">
					<div class="card mb-4">
						<div class="card-header">
							<h5 class="card-title mb-0">Immagini Attuali</h5>
						</div>
						<div class="card-body p-0">
							<div id="ricettaCarousel" class="carousel slide" data-bs-ride="carousel">
								<div class="carousel-inner" id="carouselInner">
									<div th:each="urlImage, iterStat : ${ricetta.urlsImages}" class="carousel-item"
										th:classappend="${iterStat.index == 0} ? 'active'">
										<img th:src="${urlImage}" class="d-block w-100" alt="Immagine Ricetta" />
									</div>
								</div>
								<button class="carousel-control-prev" type="button" data-bs-target="#ricettaCarousel"
									data-bs-slide="prev">
									<span class="carousel-control-prev-icon" aria-hidden="true"></span>
									<span class="visually-hidden">Previous</span>
								</button>
								<button class="carousel-control-next" type="button" data-bs-target="#ricettaCarousel"
									data-bs-slide="next">
									<span class="carousel-control-next-icon" aria-hidden="true"></span>
									<span class="visually-hidden">Next</span>
								</button>
							</div>
						</div>
					</div>
				</div>

				<!-- Colonna Modifica Ricetta -->
				<div class="col-md-4">
					<div class="md-3">
						<label for="nome" class="form-label">Nome</label>
						<input type="text" class="form-control" id="nome" name="nome" th:value="${ricetta.nome}"
							required>
					</div>
					<div class="md-3">
						<label for="descrizione" class="form-label">Descrizione</label>
						<textarea class="form-control" id="descrizione" name="descrizione" rows="5" required
							th:text="${ricetta.descrizione}"></textarea>
					</div>
					<div class="md-4">
						<label for="fileImages" class="form-label">Carica nuove foto della ricetta (opzionale)</label>
						<input type="file" class="form-control" id="fileImages" name="fileImages" accept="image/*"
							multiple onchange="loadFiles(event)">
						<div class="form-text">Assicurati di caricare foto chiare e recenti della ricetta.</div>
					</div>
				</div>


				<!-- Colonna Ingredienti -->
				<div class="col-md-4">
					<div>Ingredienti</div>
					<div id="ingredienti-section" class="scrollable-container overflow-auto" style="max-height: 350px;">
						<!-- Visualizza le righe ricetta esistenti -->
						<div th:each="rigaRicetta : ${ricetta.righeRicetta}"
							class="row align-items-center mb-2 ingredienti-group">
							<div class="col-md-6">
								<select class="form-control" name="ingredientiIds">
									<option th:each="ing : ${ingredienti}" th:value="${ing.id}" th:text="${ing.nome}"
										th:selected="${ing.id == rigaRicetta.ingrediente.id}"></option>
								</select>
							</div>
							<div class="col-md-4">
								<input type="text" class="form-control" name="quantita"
									th:value="${rigaRicetta.quantita}" placeholder="Quantità">
							</div>
							<div class="col-md-1 p-0">
								<button type="button" class="btn btn-danger remove-ingrediente">
									<img src="/images/trash.svg" alt="Remove" style="filter: invert(1);">
								</button>
							</div>
						</div>
						<!-- Template per aggiungere nuovi ingredienti -->
						<template id="ingredient-template">
							<div class="row align-items-center mb-2 ingredienti-group">
								<input type="hidden" name="righeRicetta[__index__].id">
								<div class="col-md-6">
									<select class="form-control" name="righeRicetta[__index__].ingrediente.id" required>
										<option th:each="ing : ${ingredienti}" th:value="${ing.id}"
											th:text="${ing.nome}">Ingrediente</option>
									</select>
								</div>
								<div class="col-md-4">
									<input type="text" class="form-control" name="righeRicetta[__index__].quantita"
										placeholder="Quantità">
								</div>
								<div class="col-md-1 p-0">
									<button type="button" class="btn btn-danger remove-ingrediente">
										<img src="/images/trash.svg" alt="Remove" style="filter: invert(1);">
									</button>
								</div>
							</div>
						</template>
					</div>
					<div class="d-flex justify-content-center">
						<button type="button" class="btn btn-primary mb-3" id="add-ingrediente">Aggiungi
							Ingrediente</button>
					</div>
					<div class="d-flex justify-content-center">
						<a href="/addIngredienti" class="text-primary mb-3">Non trovi l'ingrediente che cerchi?
							Aggiungilo qui!</a>
					</div>
				</div>


			</div>
			<button type="submit" class="btn btn-primary w-100">Salva Modifiche</button>

		</form>

	</div>

	<!-- Include il footer -->
	<div th:replace="~{fragments/footer :: footer}"></div>

	<!-- Script per la preview delle nuove immagini e la gestione degli ingredienti -->
	<script>
		function loadFiles(event) {
			const files = event.target.files;
			const carouselInner = document.getElementById('carouselInner');
			carouselInner.innerHTML = '';

			for (let i = 0; i < files.length; i++) {
				const reader = new FileReader();
				reader.onload = function (e) {
					const div = document.createElement('div');
					div.className = 'carousel-item';
					if (i === 0) div.classList.add('active');
					div.innerHTML = `<img src="${e.target.result}" class="d-block w-100" alt="Immagine Ricetta ${i + 1}" />`;
					carouselInner.appendChild(div);
				};
				reader.readAsDataURL(files[i]);
			}
		}

		document.getElementById('add-ingrediente').addEventListener('click', function () {
			const template = document.getElementById('ingredient-template').content.cloneNode(true);
			const section = document.getElementById('ingredienti-section');

			// Conta gli elementi attuali per determinare il nuovo indice
			const newIndex = section.getElementsByClassName('ingredienti-group').length;

			// Sostituisci il placeholder __index__ con il nuovo indice
			const newGroup = template.querySelector('.ingredienti-group');
			newGroup.innerHTML = newGroup.innerHTML.replace(/__index__/g, newIndex);

			section.appendChild(template);
		});

		document.addEventListener('click', function (e) {
			if (e.target && e.target.classList.contains('remove-ingrediente')) {
				e.target.closest('.ingredienti-group').remove();
			}
		});
	</script>
</body>

</html>