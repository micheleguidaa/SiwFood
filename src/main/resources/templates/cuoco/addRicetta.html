<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments/header :: header('Aggiungi Ricetta')">
	<style>
		.image-container img {
			width: 100%;
			object-fit: cover;
			max-height: 280px;
			min-height: 280px;
		}

		.scrollable-container {
			max-height: 300px;
			overflow-y: auto;
		}
	</style>
</head>

<body>
	<div th:replace="fragments/navbar :: navbar"></div>
	<div class="container mt-5 form-container ">
		<h2 class="text-center mb-4">Aggiungi Ricetta</h2>
		<form th:action="@{/addRicetta}" method="post" enctype="multipart/form-data">
			<!-- Aggiungi il campo nascosto per l'ID del cuoco -->
			<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
			<input type="hidden" id="cuocoId" name="cuocoId" th:value="${cuocoCorrente.id}" />

			<div class="row">
				<!-- Colonna Immagini -->
				<div class="col-md-4">
					<div class="card mb-4">
						<div class="card-header">
							<h5 class="card-title mb-0">Immagini Ricetta</h5>
						</div>
						<div class="card-body p-0">
							<div id="ricettaCarousel" class="carousel slide" data-bs-ride="carousel">
								<div class="carousel-inner" id="carouselInner">
									<div class="carousel-item active">
										<img src="/images/SenzaRicetta.jpeg" class="d-block w-100"
											alt="Immagine Ricetta" />
									</div>
								</div>
								<button class="carousel-control-prev" type="button" data-bs-target="#ricettaCarousel"
									data-bs-slide="prev">
									<span class="carousel-control-prev-icon" aria-hidden="true"></span>
									<span class="visually-hidden">Previous</span>
								</button>
								<button class="carousel-control-next" type="button" data-bs-target="#ricettaCarousel"
									data-bs-slide="next">
									<span class="carousel-control-next-icon" aria-hidden="true"></span>
									<span class="visually-hidden">Next</span>
								</button>
							</div>
						</div>
					</div>
				</div>

				<!-- Colonna Inserimento Dati -->
				<div class="col-md-4">
					<div class="mb-3">
						<label for="nome" class="form-label">Nome</label>
						<input type="text" class="form-control" id="nome" name="nome" placeholder="Nome della ricetta"
							required>
					</div>
					<div class="mb-3">
						<label for="descrizione" class="form-label">Descrizione</label>
						<textarea class="form-control" id="descrizione" name="descrizione" rows="4"
							placeholder="Descrizione della ricetta"></textarea>
					</div>

					<div class="mb-3">
						<label for="fileImages" class="form-label">Carica immagini della ricetta</label>
						<input type="file" class="form-control" id="fileImages" name="fileImages" accept="image/*"
							multiple required onchange="loadFiles(event)">
						<div class="form-text">Assicurati di caricare foto chiare e invitanti della ricetta.</div>
					</div>
				</div>
				<div class="col-md-4">
					<!-- Sezione Ingredienti -->
					<div>Ingredienti</div>
					<div id="ingredienti-section" class="scrollable-container overflow-auto" style="max-height: 350px;">
						<!-- Template per gli ingredienti -->
						<template id="ingredient-template">
							<div class="row align-items-center mb-2 ingredienti-group">
								<div class="col-md-6 p-1">
									<select class="form-control" name="ingredientiIds" required>
										<option th:each="ing : ${ingredienti}" th:value="${ing.id}"
											th:text="${ing.nome}">Ingrediente</option>
									</select>
								</div>
								<div class="col-md-4  p-2">
									<input type="text" class="form-control" name="quantita" placeholder="QuantitÃ ">
								</div>
								<div class="col-md-1  p-0">
									<button type="button" class="btn btn-danger remove-ingrediente">
										<img src="/images/trash.svg" alt="Remove" style="filter: invert(1);">

									</button>
								</div>
							</div>
						</template>
					</div>

					<div class="d-flex justify-content-center">
						<button type="button" class="btn btn-primary mb-3" id="add-ingrediente">Aggiungi
							Ingrediente</button>
					</div>

					<div class="d-flex justify-content-center">
						<a href="/addIngredienti" class=" text-primary mb-3">Non trovi l'ingrediente che cerchi?
							Aggiungilo qui!</a>
					</div>
				</div>

				<button type="submit" class="btn btn-success mt-1">Salva Ricetta</button>
		</form>
	</div>
	</div>

	<div th:replace="fragments/footer :: footer"></div>

	<!-- Script per la preview delle immagini e la gestione degli ingredienti -->
	<script>
		function loadFiles(event) {
			const files = event.target.files;
			const carouselInner = document.getElementById('carouselInner');
			carouselInner.innerHTML = '';

			for (let i = 0; i < files.length; i++) {
				const reader = new FileReader();
				reader.onload = function (e) {
					const div = document.createElement('div');
					div.className = 'carousel-item';
					if (i === 0) div.classList.add('active');
					div.innerHTML = `<img src="${e.target.result}" class="d-block w-100" alt="Immagine Ricetta ${i + 1}" />`;
					carouselInner.appendChild(div);
				};
				reader.readAsDataURL(files[i]);
			}
		}

		document.getElementById('add-ingrediente').addEventListener('click', function () {
			const template = document.getElementById('ingredient-template').content.cloneNode(true);
			document.getElementById('ingredienti-section').appendChild(template);
		});

		document.addEventListener('click', function (e) {
			if (e.target && e.target.classList.contains('remove-ingrediente')) {
				e.target.closest('.ingredienti-group').remove();
			}
		});
	</script>
</body>

</html>